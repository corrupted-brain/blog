<p>During the penetration testing of a target, the <a href="https://github.com/projectdiscovery/nuclei">nuclei</a> results show that the website of an organization is vulnerable to code execution vulnerability i.e <a href="https://blog.ovhcloud.com/cve-2017-9841-what-is-it-and-how-do-we-protect-our-customers/">CVE-2017-9841</a>. The CVE-2017-9841 vulnerability lets a user run PHP code on vulnerable websites remotely, by exploiting a breach in PHPUnit lets us run desirable PHP codes and read sensitive files.</p>

<p>After checking all the things, I verified the existence of vulnerability making the proper request in Burp suite, and confirmed by running of the PHP function,  <code class="highlighter-rouge">getcwd()</code> that returns the current working directory.<img src="/images/posts/rce1.png" alt="php getcwd() function" />
Now there wonâ€™t be any problem running system commands by using the <code class="highlighter-rouge">shell_exec()</code> function in PHP. This function executes user-supplied commands and returns output as a string. I did this by simply listing all the home directories/files of the current user.<img src="/images/posts/rce2.png" alt="" /> Finally, reading the config file was just easy as reading this post. <img src="/images/posts/rce3.png" alt="" /> I stopped over here and thought of reporting this issue to the organization but because of the tight schedule of my daily life I was unable to report the issue for 4-5 days. After a few days I thought of reporting the issue but wanted to confirm whether the vulnerability still exists or not. <strong>But to my surprise ðŸ˜• It wasnâ€™t working as before</strong> ðŸ˜‚. <img src="/images/posts/rce4.png" alt="" />
As per my guess within 4-5 days, the administrator might have checked the logs or might be aware of the exploit that I tried and made fixation to it. Hence, the execution of <code class="highlighter-rouge">shell_exec()</code> function was forbidden. However, few other functions could still be executed except shell_exec(). From the image below I confirmed that the execution was forbidden by applying some filter in the phpinfo file.<img src="/images/posts/rce5.png" alt="" /> Along with shell_exec(), other functions like <code class="highlighter-rouge">show_source(), system(), shell_exec(), exec(), popen() and  proc_open()</code> which can be used to read/write files were also disabled.
After this I started looking for other possible ways to read the files again, and found we can use the <a href="https://www.php.net/manual/en/function.glob.php"><code class="highlighter-rouge">glob()</code></a> method to return an array of filenames and directories. I used following snippet of code locally and confirmed it returns the array of files and directories.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nb">glob</span><span class="p">(</span><span class="s2">"*"</span><span class="p">));</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>Eventually, I was able to  list the files again as shown below, and now all thatâ€™s left is to find a way to read those listed files.<img src="/images/posts/rce6.png" alt="" />  At the end, I figured out that I had to combine multiple functions together to read files.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nv">$a</span> <span class="o">=</span> <span class="s1">'../../../../../../../public_html/application/config/database.php'</span><span class="p">;</span>
<span class="nv">$b</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">','</span><span class="p">,</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$a</span><span class="p">));</span>
<span class="nb">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span> <span class="cp">?&gt;</span>
</code></pre></div></div>
<p>In the above code,</p>
<ul>
  <li>$a variable is used to set target file which we are going to read. The target file was found using print_r(glob());</li>
  <li>In the $b variable, we used explode function to return array of strings. file_get_contents() reads contents of database.php from public_html/application/config/database.php and contents array is returned.</li>
  <li>Finally, printed contents of $b variable using print_r() or var_dump() can also be used. 
<img src="/images/posts/rce7.png" alt="" /></li>
</ul>
