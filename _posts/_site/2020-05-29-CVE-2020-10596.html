<p style="text-align: justify;"> Cross-site scripting attacks (XSS),is a type of attack in which malicious scripts are injected into websites and web applications and run on an end user’s platform. Vulnerable endpoints are found and JS code is injected to execute it for malicious purpose. Such endpoints can be search fields, profile information fields , file upload functions and many more. </p>

<p>In authenticated attack refers to the conditions where an attacker must be logged in order to exploit the vulnerabilitiy. In <a href="https://www.opencart.com">OpenCart</a> 3.0.3.2 it is possible to execute cross site scripting attack since the profile image upload feature in admin panel is not escaping user inputs.</p>

<p><strong>To execute follow the steps below.</strong></p>
<ul>
  <li>Login to admin panel, navigate to system &gt; users &gt; edit existing user.</li>
  <li>Go to Image change section and select a file with the XSS payload as <code class="highlighter-rouge">"&gt;&lt;svg onload=alert("XSS")&gt;</code> and save it.</li>
  <li>Thats it.
 <img src="/images/posts/xss-popup.png" alt="XSS Popup" /></li>
</ul>

<p><strong>What’s the solution ???</strong></p>

<p style="text-align: justify;"> Same payload gets executes for directory name too. So, I suggested a regex which replaces special characters in filename/directory name with whitespaces and removes white spaces too. </p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Sanitize the filename</span>
<span class="nv">$filename</span> <span class="o">=</span> <span class="nb">basename</span><span class="p">(</span><span class="nb">html_entity_decode</span><span class="p">(</span><span class="nv">$file</span><span class="p">[</span><span class="s1">'name'</span><span class="p">],</span> <span class="nx">ENT_QUOTES</span><span class="p">,</span> <span class="s1">'UTF-8'</span><span class="p">));</span>
<span class="c1">//Using regex to filter filename</span>
<span class="nv">$filename</span><span class="o">=</span><span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/[^A-Za-z0-9\-\.]/'</span><span class="p">,</span><span class="s1">''</span><span class="p">,</span><span class="nv">$filename</span><span class="p">);</span>
<span class="c1">// Validate the filename length</span>
<span class="k">if</span> <span class="p">((</span><span class="nx">utf8_strlen</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">utf8_strlen</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span> <span class="p">{</span>
<span class="nv">$json</span><span class="p">[</span><span class="s1">'error'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">language</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'error_filename'</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">GO_Example_Model_Thing</span> <span class="k">extends</span> <span class="nx">GO_Base_Db_ActiveRecord</span> <span class="p">{</span>
    <span class="o">...</span>

</code></pre></div></div>
<p><strong>Outcome:</strong></p>

<p><img src="/images/posts/xss-filtered.png" alt="XSS Filter" /></p>

<p>But this won’t work if the file containing payload is uploaded using FTP service. So one of the solution on issue I have opened on github was <code class="highlighter-rouge">preg_replace('/[^a-zA-Z0-9\_\.\?]/', '', basename(html_entity_decode($this-&gt;request-&gt;post['x'], ENT_QUOTES, 'UTF-8')));</code> by <strong><em>straightlight</em></strong>. Let’s see how they add fix in the main code of the opencart in next release.</p>

